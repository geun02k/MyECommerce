# MY E-COMMERCE PROJECT 요구사항 명세서

## < 프로젝트 스터디 내용 >
> - [x] JWT토큰 및 스프링 시큐리티 사용을 통한 인증,인가
>   - 인증, 인가되지 않은 사용자의 접근을 막기위해
> - [ ] redis를 이용한 캐싱
>   - 조회속도 높이기 위해
> - [ ] 결제 시 트랜잭션과 Lock을 이용한 동시성 제어
>   - 결제 발생 시 재고 감소가 동시 발생하지 않도록 하기위해
> - [ ] 스프링 배치 사용하기 (필수 목표 과다로 삭제권장)
>   - 일정시간마다 반복하는 기능 만들기
> - [ ] 로그파일생성
>   - 모니터링을 위한 로그파일 생성하기
> - [x] 테스트코드 작성
>   - 일일이 api를 호출하지 않고 기능의 정확성을 확인하기 위해


## < 프로젝트 요구사항 정의 >
    필요 테이블 : 회원테이블(판매자/고객 동시관리), 회원별권한테이블,
                상품테이블, 상품옵션테이블, 주문테이블, 결제테이블
#### 공통
- [x] **로그인**
    - [x] 아이디, 패스워드 정보 일치 시 로그인 가능
    - [x] 로그인 시 토큰 발생
    - [x] 로그인 시 redis에 토큰 저장
    - [x] 로그인 시 토큰을 이용한 접근권한제어
        - 로그인하지 않은 고객은 상품 조회만 가능.
        - 로그인한 회원은 상품조회 외 페이지 접근가능. (단, 권한에 따른 접근페이지 상이)
        - JWT, Filter 이용해 간략하게 진행.
- [x] **로그아웃**
    - [x] redis에 저장한 토큰 삭제로 로그아웃처리

---
#### 판매자
- [x] 셀러(회원) 가입
    - 회원 아이디는 unique.
    - 전화번호 중복불가 등 유효성검증.
    - 비밀번호 암호화 처리.
    - 입력데이터 : 사용자아이디, 비밀번호, 이름, 전화번호, 주소.
    - 주소 외 필수입력.
    - 회원가입 시 삭제여부 = 'N'
    - 회원가입 시 SELLER(판매자) 권한 부여. (권한코드 enum으로 관리)
- [x] 상품 등록
    - [x] 셀러 회원가입 후 등록가능.
    - [x] 상품 입력데이터 : 상품코드, 상품명, 분류, 설명.
    - [x] 상품옵션 입력데이터 : 옵션코드, 옵션명, 가격, 수량.
    - [x] 설명을 제외한 데이터는 필수입력.
    - [x] 상품등록 시 상품판매상태 = 'ON_SALE'로  기본설정.
    - [x] 한 상품 등록 시 대한 여러 상품옵션 등록가능.
    - [x] 판매자별 상품코드, 옵션코드 중복등록 방지. (판매가 자신이 상품을 자신의 코드체계로 관리하기 위함.)
    - [x] 상품판매상태 도메인 : ON_SALE(판매중) / DELETION(삭제)
    - [x] 상품분류 도메인 : 1(여성의류) / 2(남성의류) / 3(패션잡화) / 4(뷰티) / 5(전자제품) / 6(아웃도어) / 7(유아용품) / 99(기타)   
      공통코드로 관리.
    - [x] 상품은 최소 하나 이상의 상품옵션을 가져야함.
    - [x] 상품 등록 시, 옵션별 재고 캐시 데이터 등록.
    - [ ] 상품별 최대 구매 가능수량 설정
- [ ] 상품 수정
    - [x] 판매자 본인이 판매하는 상품만 수정가능.
    - [x] 가격이 변경되거나 상품명 변경 시에는 상품을 수정하지 않고 새로 등록하도록 함.
    - [x] 한 상품에 대해 상품옵션은 추가 등록할 수 있음.
    - [x] 상품 수정가능 데이터 : 설명, 판매상태.
    - [x] 상품옵션 수정가능 데이터 : 수량.
    - [x] 상품판매상태 = DELETION(삭제)인 경우 판매 종료된 상품으로 수정불가.
    - [x] 상품판매상태 = ON_SALE(판매중), DISCONTINUED(판매중단)인 경우 다른 판매상태로 변경 가능.      
          ON_SALE(판매중)인 경우 판매중단을 위해 DISCONTINUED(판매중단), 판매종료를 위해 DELETION(삭제)으로 변경가능.    
          DISCONTINUED(판매중단)인 경우 재판매를 위해 ON_SALE(판매중), 판매종료를 위해 DELETION(삭제)으로 변경가능.
    - [x] 판매상태 변경에 따른 상품/옵션 수정   
          판매중, 판매중단으로 변경 시 상품/옵션 수정 가능.   
          판매종료로 변경 시 판매상태 외 변경 불가.
    - [x] 상품옵션의 경우, 판매수량이 0이면 주문 불가하므로 상품옵션에는 상태를 따로 두지 않음.
    - [x] 상품은 최소 하나 이상의 상품옵션을 가져야함.   
          (상품 수정은 시 옵션은 추가, 수정만 가능하므로 이미 옵션이 없을 수 없음)
    - [ ] 잘못 등록한 상품에 대해 판매자가 관리하지 않도록 판매자의 상품내역에 노출되지 않도록 삭제여부(del_yn) 컬럼 사용.   
          (과하다.)
    - [x] 판매상태 변경에 따른 재고 캐시 데이터 동기화.    
          장바구니 조회 시 구매 가능 여부 확인을 위한 재고를 빠르게 1차 확인 가능하도록 Redis에서 캐시로 관리.   
          판매중으로 변경하는 경우 재고 등록, 판매중단/판매종료로 변경하는 경우 재고 삭제.
- [ ] 상품 삭제
    - [ ] 판매자 본인이 판매하는 상품만 삭제가능.
    - [ ] 주문 테이블이 존재하므로 데이터 유지를 위해 상품등록 시 상품판매상태 = 'DELETION'으로 변경해 논리적 삭제.
    - [ ] 상품 삭제 시 상품옵션도 논리적 삭제.
    - [ ] 삭제 시 redis에 캐싱된 재고 정보 제거.

---
#### 고객
- [x] 고객(회원) 가입
    - 회원 아이디는 unique.
    - 전화번호 중복불가 등 유효성검증.
    - 비밀번호 암호화 처리.
    - 입력데이터 : 사용자아이디, 비밀번호, 이름, 전화번호, 주소.
    - 전체데이터 필수입력.
    - 회원가입 시 삭제여부 = 'N'
    - 회원가입 시 CUSTOMER(소비자) 권한 부여. (권한코드 enum으로 관리)
- [x] **상품 검색**
    - [x] 권한에 관계없이 검색가능.
    - [x] 키워드 제한
        - [X] 한글자 이상 입력.
        - [x] 50자를 초과하는 경우 50자까지만 잘라서 쿼리수행.
        - [x] LIKE 검색.
    - [x] pageable 이용해 기본 5건씩 출력.
    - [x] 정렬
        - [x] 정확도순으로 기본 정렬 (LIKE 검색으로 일치하는 글자 외 남은 글자수가 적은 순서로 정렬)
        - [x] 상품정렬기준 도메인 : 정확도순, 최신등록순, 가격순
    - [x] 판매상태='ON_SALE'인 상품에 대해서만 검색가능. (판매종료, 판매중단인 경우 노출불가)
- [x] 상품상세정보 조회
    - [x] 권한에 관계없이 조회가능.
    - [x] 조회 정보 : 상품ID, 판매자, 상품코드, 상품명, 분류, 설명, 상품ID에 해당하는 상품옵션목록.
- [ ] **장바구니에 상품추가**
    - [x] 로그인 한 고객만 장바구니에 상품추가 가능.     
          (아래와 같이 구조만으로 막을 수 없는 정책으로 Controller에서 인증/인가 절차를 거치고 도메인 정책으로 메서드로 명시해 이중방어)
    - [x] 상품상세정보 조회 화면에서 상품추가.   
          (장바구니 목록에서 추가하는 것은 수량이 대체되어야 하므로 신규개발 필요) 
    - [x] 본인 장바구니만 추가 가능    
          (클라이언트가 장바구니를 결정하지 못하게 서버에서 redis key를 memberId로 생성하면서 구조적으로 보장. 
           Controller에서 @AuthenticationPrincipal 이용해 인증객체 전달받도록 설계.
           클라이언트의 입력을 막고 memberId는 서버에서만 생성하므로 검증은 필요없는 구조 자체가 정책인 경우가 됨.
           Redis 키를 서버에서만 결정하고 외부 입력이 없으며, Controller에서 memberId를 따로 받지 않고 Security에서 CUSTOMER만 통과하는 상태에서는 정책을 메서드로 또 작성하는 것은 실패할 수 없는 검증을 만드는 것으로 의미 없는 방어 코드가 되므로 불필요.) 
    - [x] 상품추가를 위해 옵션 및 수량 필수 선택.    
          (입력값만 검증)
    - [x] 입력 데이터 : 상품코드, 상품옵션코드, 구매수량
    - [x] redis 캐싱 기능 이용해 구현.    
          (만료정책사용해 영구히 저장되지 않도록 함)
    - [ ] 상품 옵션별 최대 수량 제한 비즈니스 정책 추가 고려.   
          (우선, 입력값 검증으로만 막아두고, 추후 주문 시 제한 둘 것이므로 시간나면 장바구니 추가 시 제한 둘 것)
- [ ] **장바구니에서 상품삭제**
    - 고객 본인의 장바구니 상품만 삭제가능.
    - redis 캐싱 기능 이용해 구현.
- [ ] **장바구니 상품목록 조회**
    - [x] 본인 장바구니만 조회 가능    
      (클라이언트가 장바구니를 결정하지 못하게 서버에서 redis key를 memberId로 생성하면서 구조적으로 보장.
      Controller에서 @AuthenticationPrincipal 이용해 인증객체 전달받도록 설계.
      클라이언트의 입력을 막고 memberId는 서버에서만 생성하므로 검증은 필요없는 구조 자체가 정책인 경우가 됨.
      Redis 키를 서버에서만 결정하고 외부 입력이 없으며, Controller에서 memberId를 따로 받지 않고 
      Security에서 CUSTOMER만 통과하는 상태에서는 정책을 메서드로 또 작성하는 것은 
      실패할 수 없는 검증을 만드는 것으로 의미 없는 방어 코드가 되므로 불필요.)
    - [x] 품절된 상품, 판매하지않는 상품에 대해 주문불가하도록 품절여부=true로 설정해 전달.    
          판매가능한 상품에 대해 주문가능하도록 품절여부=false로 설정해 전달.
    - [x] redis 인메모리 저장소 이용해 구현.
    - [ ] 상품등록에서 구매 가능 수량 제한 시, 구매 가능 수량(availableQuantity)는 제한 수량과 재고 중 작은 수로 셋팅.
- [x] 상품 주문
    - [x] 상품주문을 위해 회원가입 필수.
    - [x] 고객만 주문 가능.
    - [x] 다건 주문 가능
    - [x] 품절된 상품, 판매하지않는 상품(품절여부=true)에 대해 주문불가처리.
    - [x] 주문하려는 상품의 재고가 판매가능한 재고보다 많은 경우 주문불가.
    - [x] 상품이 주문된 경우 판매재고량 감소.
    - [x] 상품주문 시 필요정보: 상품ID, 옵션코드. 주문수량, 주문자, 주문일시
- [ ] 상품 결제
    - PG사 연동 결제 api를 이용한 결제서비스 생성해 결제진행. (PG사 실연동 x)
    - 결제 실패 시 상품주문을 취소처리.
    - 동시성제어 필요여부확인 후 개발진행.
    - 참고블로그   
      https://velog.io/@jonghyun3668/%EA%B2%B0%EC%A0%9C-%EA%B3%BC%EC%A0%95-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0PG%EC%82%AC-%EC%97%B0%EB%8F%99
    - 결제 완료 후 주문상태 '결제완료'로 변경.


---
### 2. 고도화
#### 공통
- [ ] 회원정보 수정
    - 수정가능 데이터 : 비밀번호, 전화번호, 주소
- [ ] 회원정보 삭제
    - 회원정보 삭제여부='Y'로 변경해 논리적 삭제.
- [ ] 회원정보 조회
    - 회원테이블의 컬럼 전체 조회가능.
- [ ] 회원가입 시 인증절차 추가
    - 이메일 또는 핸드폰 인증 진행. (추후 확정 예정)
- [ ] 로그생성
    - ERROR 로그 파일 별도 생성.
    - ERROR 외 로그 파일 생성.
    - 파일이 일정 사이즈에 도달하는 경우 새로운 로그파일 생성.
    - 자동 일자별 로그파일 압축.
    - 일자별 로그파일 최대 보관주기(~일), 해당 설정일 이상된 파일은 자동으로 제거.

#### 판매자
- [ ] 판매상품내역 조회
    - 판매자 본인이 등록한 상품내역 조회.
- [ ] 주문내역 조회
    - 일자별 결제완료된 주문내역 조회가능.
    - pageable 이용해 5건씩 출력.
    - 최신 주문 순 정렬.
    - 본인이 등록한 상품에 대한 주문내역만 조회가능.
- [ ] 주문상태수정 - 배송중 (배송관련처리)
    - 주문상태 도메인 : 1(결제완료) / 2(배송중) / 3(배송완료) / 4(구매확정) / 5(결제취소)
      11(교환요청) / 12(교환완료)      
      21(반품요청) / 22(반품완료)      
      공통코드로 관리.
    - 판매자 본인의 판매물품에 대한 결제완료된 주문에 대해 배송가능.
    - 주문확인 후 상품에 대한 배송한 경우 판매자는 주문상태코드를 배송완료로 변경.
- [ ] 주문상태수정 - 배송완료 (배송관련처리)
    - 판매자 본인의 판매물품에 대한 배송중인 주문에 대해 배송완료가능.
    - 배송중인 주문에 대해 판매자는 주문상태코드를 배송완료로 변경.
- [ ] 주문상태수정 - 반품완료 (반품관련처리)
    - 판매자 본인의 판매물품 주문에 대한 반품요청 건에 대해 상품을 반품받은 경우 반품완료처리 가능.
    - 주문에 대한 반품완료 시 해당 상품에 대한 수량을 주문했던 수량만큼 증가.
    - 반품완료 시 결제금액 환불.
- [ ] 주문상태수정 - 교환완료 (교환관련처리)
    - 판매자 본인의 판매물품 주문에 대한 교환요청 건에 대해 상품을 교환해준 경우 교환완료처리 가능.
    - 교환완료 처리 시 기존 주문건에 대한 상품옵션 수량증가 처리. (수량복구)
- [ ] 주문 알림
  - 10분 마다 결제완료된 상품이 있는 판매자에게 알림 전송. (배치처리)
  - 판매자에게 알림을 전송하기 위해 공지테이블에 결제완료된 주문 건 수를 포함한 알림저장.
  - ex) '상품명(상품코드)에 대한 3건의 주문이 있습니다.'

#### 고객
- [ ] 상품 주문취소
    - 결제완료되고 배송중이지 않은 상품에 대해 결제취소가능.
    - PG사 연동 결제 api를 이용한 결제서비스 생성해 결제취소진행.
- [ ] 상품 반품신청
    - 배송완료된 상품에 대해 반품요청가능.
- [ ] 상품 교환신청
    - 배송완료된 상품에 대해 교환요청가능.
    - 동일 상품에 대해 옵션만 변경해 교환요청가능.
    - 교환요청 시 동일상품에 대해 변경한 옵션에 신규주문생성.
    - 기존주문 데이터에 교환요청한 신규주문의 주문아이디 update. (주문테이블 교환주문아이디 입력)
    - 상품에서 선택한 옵션에 대한 금액이 상이한 경우, 추가결제 혹은 부분결제취소.   
      (가능여부확인필요. 부분결제취소 불가한 경우 옵션별 동일할 수 있도록 상품등록 시 체크로직추가 필수.    
      혹은 상품옵션테이블 가격정보 제거 및 상품테이블에 가격컬럼추가.)


